<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NudgeNest - Your Next Project Idea</title>
    <style>
        /* --- Import Playful Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Pacifico&display=swap');

        /* --- Global Styles & Resets --- */
        :root {
            --bg-color: #fefcfb;
            --text-color: #333;
            --primary-accent: #ff6b6b; /* Playful Coral */
            --secondary-accent: #4ecdc4; /* Mint */
            --card-bg: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.1);
            --radius-sm: 8px;
            --radius-lg: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
        }

        /* --- Main Container --- */
        .container {
            width: 100%;
            max-width: 600px;
        }

        /* --- Logo/Banner Styling --- */
        .logo-banner {
            font-family: 'Pacifico', cursive;
            font-size: 3rem;
            text-align: center;
            color: var(--primary-accent);
            margin-bottom: 1.5rem;
            cursor: default;
            transition: transform 0.2s ease-in-out;
        }

        .logo-banner:hover {
            transform: scale(1.02);
        }
        
        /* --- Form View Styling --- */
        #form-view {
            animation: fadeIn 0.5s ease-out;
        }

        h2 {
            text-align: center;
            font-weight: 700;
            color: #555;
            margin-bottom: 1.5rem; /* Adjusted margin */
        }

        /* --- NEW: Search Form Styling --- */
        #search-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        #search-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: var(--radius-sm);
            background-color: #fff;
        }

        #search-button {
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 800;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: var(--radius-sm);
            background-color: var(--secondary-accent);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #search-button:hover {
            background-color: #3bbbb2;
            box-shadow: var(--shadow-hover);
        }
        
        .separator-text {
            text-align: center;
            font-weight: 700;
            color: #aaa;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
        }
        /* --- End Search Styling --- */

        #idea-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: #444;
        }

        .form-group select {
            padding: 0.75rem 1rem;
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: var(--radius-sm);
            background-color: #fff;
            appearance: none; /* Removes default OS styling */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%234ECDC4%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.5%2017.5%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20127.9c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-13%200-5-1.9-9.2-5.4-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 0.8em;
            cursor: pointer;
        }

        .form-group select:disabled {
            background-color: #f4f4f4;
            color: #aaa;
            cursor: not-allowed;
        }

        /* --- Button Styling --- */
        .btn {
            font-family: 'Nunito', sans-serif;
            font-size: 1rem;
            font-weight: 800;
            padding: 0.9rem 1.5rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: var(--primary-accent);
            color: white;
            margin-top: 1rem;
        }

        .btn-primary:hover {
            background-color: #ff4747;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .btn-secondary {
            background-color: var(--secondary-accent);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #3bbbb2;
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        /* --- Idea View Styling --- */
        #idea-view {
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s ease-out;
        }

        /* This container now holds MULTIPLE cards */
        #idea-card-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Adds spacing between cards in search results */
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 2rem;
            /* margin-bottom: 1.5rem; Removed, using gap on container */
            border-top: 5px solid var(--secondary-accent);
        }
        
        .card.exhausted-card {
            border-top-color: var(--primary-accent);
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: #555;
        }

        .card .logo-banner {
            font-size: 2rem;
            margin-bottom: 1rem;
            text-align: left;
            color: var(--primary-accent);
        }

        .card h3 {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }
        
        .card h4 {
            font-size: 0.9rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--primary-accent);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.25rem;
        }

        .card p, .card ul {
            font-size: 1rem;
            line-height: 1.6;
            color: #444;
        }

        .card ul {
            padding-left: 1.2rem;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #f0f0f0;
        }

        .tag {
            display: inline-block;
            background-color: #f0f0f0;
            color: #555;
            padding: 0.25rem 0.75rem;
            border-radius: 99px; /* Pill shape */
            font-size: 0.85rem;
            font-weight: 700;
        }

        .tag.tag-topic { background-color: #e0fbf9; color: #1ca093; }
        .tag.tag-mood { background-color: #ffeaea; color: #e05252; }
        .tag.tag-complex { background-color: #fff6e0; color: #c9a22f; }
        .tag.tag-result { background-color: #e6f0ff; color: #407de7; }

        /* Navigation buttons (for random mode) */
        #navigation-buttons {
            display: flex; /* Changed from flex to none by default */
            gap: 1rem;
            justify-content: space-between;
            margin-top: 1.5rem; /* Add margin for spacing from card(s) */
        }
        
        #navigation-buttons .btn {
            flex-grow: 1; /* Make buttons share space */
        }
        
        /* --- NEW: Pagination Styling --- */
        #pagination-controls {
            display: none; /* Hidden by default */
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        
        .btn-page {
            background-color: #f0f0f0;
            color: #555;
            font-weight: 700;
            padding: 0.5rem 1rem;
        }
        
        .btn-page:hover {
            background-color: #e0e0e0;
        }
        
        .btn-page.active {
            background-color: var(--secondary-accent);
            color: white;
            transform: scale(1.05);
        }
        /* --- End Pagination Styling --- */

        /* --- Utility Classes --- */
        .hidden {
            display: none !important;
        }

        /* --- Animation --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

    </style>
</head>
<body>

    <main class="container">

        <section id="form-view">
            <h1 class="logo-banner">NudgeNest</h1>
            <h2>Want a new idea for web/app development?</h2>

            <form id="search-form">
                <input 
                    type="search" 
                    id="search-input" 
                    placeholder="Search by name or description..."
                    minlength="5"
                    title="Please enter at least 5 characters"
                >
                <button type="button" id="search-button">Search</button>
            </form>
            
            <h3 class="separator-text">or</h3>
            <form id="idea-form">
                
                <div class="form-group">
                    <label for="topic">1. Topic / Theme</label>
                    <select id="topic" name="topic">
                        <option value="0">--- Any Topic ---</option>
                        <option value="1">Web Development</option>
                        <option value="2" disabled>Machine Learning/AI (coming soon)</option>
                        <option value="3" disabled>Automation/Tools (coming soon)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="mood">2. Mood / Flavor</label>
                    <select id="mood" name="mood">
                        <option value="0">--- Any Mood ---</option>
                        <option value="1">Practical / Useful</option>
                        <option value="2">Playful / Funny</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="complex">3. Complexity / Constraints</label>
                    <select id="complex" name="complex">
                        <option value="0">--- Any Complexity ---</option>
                        <option value="1">One-Day Build</option>
                        <option value="2">Multi-Step / Advanced</option>
                        <option value="3">Minimalist (few features/lines)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="result">4. Result</label>
                    <select id="result" name="result">
                        <option value="0">--- Any Result ---</option>
                        <option value="1">Website</option>
                        <option value="2">App</option>
                        <option value="3">Bot / Automation</option>
                        <option value="4">Content (text, art, video)</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary">Choose desired parameters!</button>
            </form>
        </section>

        <section id="idea-view">
            
            <div id="idea-card-container"></div>

            <div id="pagination-controls"></div>

            <div id="navigation-buttons">
                <button id="reset-button" class="btn btn-secondary">Choose another</button>
                <button id="next-button" class="btn btn-primary">Next idea</button>
            </div>
        
        </section>

    </main>


    <script>
        // --- Our Data-to-Text Mappers ---
        const mapper = {
            topic: { 1: "Web Development", 2: "Machine Learning/AI", 3: "Automation/Tools" },
            mood: { 1: "Practical / Useful", 2: "Playful / Funny" },
            complex: { 1: "One-Day Build", 2: "Multi-Step / Advanced", 3: "Minimalist (few features/lines)" },
            result: { 1: "Website", 2: "App", 3: "Bot / Automation", 4: "Content (text, art, video)" }
        };

        // --- Key for Session Storage ---
        const DB_KEY = 'nudgeNestDB';
        
        // --- App State ---
        let currentFilters = {};
        // NEW: State for search and pagination
        let currentSearchResults = [];
        let currentPage = 1;
        const resultsPerPage = 3; // Show 3 results per page

        // --- DOM Element References ---
        const formView = document.getElementById('form-view');
        const ideaView = document.getElementById('idea-view');
        const ideaForm = document.getElementById('idea-form');
        const ideaCardContainer = document.getElementById('idea-card-container');
        
        const navigationButtons = document.getElementById('navigation-buttons');
        const nextButton = document.getElementById('next-button');
        const resetButton = document.getElementById('reset-button');
        
        // NEW: Search and Pagination elements
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const paginationControls = document.getElementById('pagination-controls');


        /**
         * Main entry point.
         * Runs when the page is loaded.
         */
        async function init() {
            // Load the database into Session Storage if it's not already there.
            await loadDB(); 

            // Attach event listeners
            ideaForm.addEventListener('submit', handleFormSubmit);
            nextButton.addEventListener('click', showNextIdea);
            resetButton.addEventListener('click', showFormView);
            
            // NEW: Search listener
            searchButton.addEventListener('click', handleSearch);
        }

        /**
         * Loads the db.json file into session storage
         * (Assumes you are using the db.json fetch version)
         */
        async function loadDB() {
            if (!sessionStorage.getItem(DB_KEY)) {
                try {
                    console.log('Fetching database from db.json...');
                    const response = await fetch('./db.json'); 
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    sessionStorage.setItem(DB_KEY, JSON.stringify(data));
                    console.log('Database loaded and cached in Session Storage.');
                } catch (error) {
                    console.error("Could not load database:", error);
                    alert("Error: Could not load the 'db.json' file.\n\nPlease make sure the file exists in the same folder and you are running this on a web server (like VS Code's 'Live Server').");
                }
            } else {
                 console.log('Database already in Session Storage.');
            }
        }

        /**
         * Handles the form submission for RANDOM ideas.
         */
        function handleFormSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(ideaForm);
            currentFilters = {
                topic: parseInt(formData.get('topic')) || 0,
                mood: parseInt(formData.get('mood')) || 0,
                complex: parseInt(formData.get('complex')) || 0,
                result: parseInt(formData.get('result')) || 0,
            };

            if (
                currentFilters.topic === 0 &&
                currentFilters.mood === 0 &&
                currentFilters.complex === 0 &&
                currentFilters.result === 0
            ) {
                alert("Please select at least one parameter to get an idea!");
                return;
            }

            // Show the first idea
            showNextIdea();

            // Toggle views and UI elements for RANDOM mode
            formView.style.display = 'none';
            ideaView.style.display = 'block';
            
            paginationControls.style.display = 'none'; // Hide pagination
            navigationButtons.style.display = 'flex'; // Show nav
            nextButton.classList.remove('hidden');    // Show "Next idea" button
        }

        /**
         * NEW: Handles the search form submission.
         */
        function handleSearch() {
            const searchTerm = searchInput.value.trim().toLowerCase();

            if (searchTerm.length < 5) {
                alert("Search term must be at least 5 characters.");
                return;
            }
            
            const allIdeas = JSON.parse(sessionStorage.getItem(DB_KEY));
            if (!allIdeas) {
                alert("Database not loaded. Please refresh.");
                return;
            }

            currentSearchResults = allIdeas.filter(idea => 
                idea.iname.toLowerCase().includes(searchTerm) ||
                idea.description.toLowerCase().includes(searchTerm)
            );

            displaySearchResults();
        }

        /**
         * NEW: Displays search results (list or paginated).
         */
        function displaySearchResults() {
            const count = currentSearchResults.length;
            ideaCardContainer.innerHTML = ''; // Clear previous results
            paginationControls.innerHTML = ''; // Clear old pagination

            if (count === 0) {
                alert("Sorry, no ideas found matching that term.");
                return; // Stay on the form view
            }

            // Toggle views and UI elements for SEARCH mode
            formView.style.display = 'none';
            ideaView.style.display = 'block';
            
            navigationButtons.style.display = 'flex'; // Show nav (for "Choose Another")
            nextButton.classList.add('hidden');       // Hide "Next idea" button

            // Logic for <3 (1, 2) or 3 results
            if (count <= 3) { 
                let allCardsHTML = '';
                currentSearchResults.forEach(idea => {
                    allCardsHTML += generateIdeaCardHTML(idea);
                });
                ideaCardContainer.innerHTML = allCardsHTML;
                paginationControls.style.display = 'none';
            } 
            // Logic for >3 (4+) results
            else {
                currentPage = 1;
                displayPaginatedResults(currentPage);
                renderPaginationControls(count);
                paginationControls.style.display = 'flex';
            }
        }
        
        /**
         * NEW: Renders just the items for the current page.
         */
        function displayPaginatedResults(page) {
            currentPage = page;
            ideaCardContainer.innerHTML = '';
            
            const start = (page - 1) * resultsPerPage;
            const end = page * resultsPerPage;
            
            const paginatedItems = currentSearchResults.slice(start, end);

            let allCardsHTML = '';
            paginatedItems.forEach(idea => {
                allCardsHTML += generateIdeaCardHTML(idea);
            });
            ideaCardContainer.innerHTML = allCardsHTML;

            // Update active state on buttons
            document.querySelectorAll('.btn-page').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.page) === currentPage) {
                    btn.classList.add('active');
                }
            });
        }

        /**
         * NEW: Creates the pagination buttons.
         */
        function renderPaginationControls(totalResults) {
            paginationControls.innerHTML = ''; // Clear
            const totalPages = Math.ceil(totalResults / resultsPerPage);

            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.innerText = i;
                pageButton.classList.add('btn', 'btn-page');
                pageButton.dataset.page = i; // Store page number
                if (i === 1) {
                    pageButton.classList.add('active'); // Activate first page
                }
                pageButton.addEventListener('click', () => displayPaginatedResults(i));
                paginationControls.appendChild(pageButton);
            }
        }

        /**
         * The core logic: Finds and displays a new, random, un-seen idea.
         */
        function showNextIdea() {
            const allIdeas = JSON.parse(sessionStorage.getItem(DB_KEY));
            
            if (!allIdeas || allIdeas.length === 0) {
                console.error("Database is empty or not loaded!");
                renderExhaustedCard(); 
                nextButton.classList.add('hidden');
                return;
            }

            const filteredIdeas = allIdeas.filter(idea => {
                const topicMatch = (currentFilters.topic === 0) || (idea.topic == currentFilters.topic);
                const moodMatch = (currentFilters.mood === 0) || (idea.mood == currentFilters.mood);
                const complexMatch = (currentFilters.complex === 0) || (idea.complex == currentFilters.complex);
                const resultMatch = (currentFilters.result === 0) || (idea.result == currentFilters.result);
                return topicMatch && moodMatch && complexMatch && resultMatch;
            });

            const cacheKey = `shown_ideas_${currentFilters.topic}_${currentFilters.mood}_${currentFilters.complex}_${currentFilters.result}`;
            let shownIds = JSON.parse(sessionStorage.getItem(cacheKey)) || [];

            const availableIdeas = filteredIdeas.filter(idea => !shownIds.includes(idea.i_id));

            if (availableIdeas.length === 0) {
                renderExhaustedCard();
                nextButton.classList.add('hidden');
                return;
            }

            const randomIndex = Math.floor(Math.random() * availableIdeas.length);
            const selectedIdea = availableIdeas[randomIndex];

            shownIds.push(selectedIdea.i_id);
            sessionStorage.setItem(cacheKey, JSON.stringify(shownIds));
            
            // MODIFIED: Use the generator function
            const cardHTML = generateIdeaCardHTML(selectedIdea);
            ideaCardContainer.innerHTML = cardHTML; // Set the single card
            nextButton.classList.remove('hidden');
        }

        /**
         * REFACTORED: Now *generates and returns* the HTML for a card.
         * This is used by both random mode and search mode.
         */
        function generateIdeaCardHTML(idea) {
            const topicText = mapper.topic[idea.topic] || "N/A";
            const moodText = mapper.mood[idea.mood] || "N/A";
            const complexText = mapper.complex[idea.complex] || "N/A";
            const resultText = mapper.result[idea.result] || "N/A";

            const formatList = (text) => {
                if (!text || !text.trim()) return `<p>${'N/A'}</p>`;
                if (!text.includes('\n')) {
                    return `<p>${text}</p>`;
                }
                const items = text.split('\n')
                                  .filter(item => item.trim() !== '')
                                  .map(item => `<li>${item.trim()}</li>`)
                                  .join('');
                if (!items) return `<p>${'N/A'}</p>`;
                return `<ul>${items}</ul>`;
            };

            // Return the HTML string
            return `
                <div class="card">
                    <div class="logo-banner">NudgeNest</div>
                    <h3>${idea.iname}</h3>
                    <p>${idea.description}</p>
                    
                    <h4>MVP Features</h4>
                    ${formatList(idea.mvp)}
                    
                    <h4>Build Plan</h4>
                    ${formatList(idea.build)}

                    <h4>Nice-to-Have Features</h4>
                    ${formatList(idea.nth)}

                    <h4>Data Format</h4>
                    <p>${idea.dformat || 'N/A'}</p>

                    <div class="tag-list">
                        <span class="tag tag-topic">${topicText}</span>
                        <span class="tag tag-mood">${moodText}</span>
                        <span class="tag tag-complex">${complexText}</span>
                        <span class="tag tag-result">${resultText}</span>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the "Out of Ideas" card (for random mode).
         */
        function renderExhaustedCard() {
            const exhaustedHTML = `
                <div class="card exhausted-card">
                    <p>Wow, you're full of energy!</p>
                    <p>Sorry, I am out of ideas for that combination at the moment. ðŸ˜…</p>
                    <p>Try different filters!</p>
                </div>
            `;
            ideaCardContainer.innerHTML = exhaustedHTML;
        }

        /**
         * Resets the app to the form view.
         */
        function showFormView() {
            formView.style.display = 'block';
            ideaView.style.display = 'none';
            
            // Clear all results
            ideaCardContainer.innerHTML = '';
            paginationControls.style.display = 'none';
            paginationControls.innerHTML = '';
            
            // Reset filters and search
            currentFilters = {};
            currentSearchResults = [];
            searchInput.value = '';
        }

        // --- Start the App ---
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>